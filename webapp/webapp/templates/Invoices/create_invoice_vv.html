{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Create Invoice</h2>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}

        <table class="table table-bordered" id="invoice-items-table">
            <thead>
                <tr>
                    <th>Sr#</th>
                    <th>Item Name</th>
                    <th>PCS</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Payment</th>
                    <th>Balance</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {{ formset.management_form }}
                {% for form in formset %}
                <tr class="item-row">
                    <!-- serial number auto-calculated -->
                    <td class="serial-number">{{ forloop.counter }}</td>

                    <!-- Render all fields except serial_no -->
                    <td class="p-2">{{ form.item_name }}</td>
                    <td class="p-2">{{ form.pcs }}</td>
                    <td class="p-2">{{ form.description }}</td>
                    <td class="p-2">{{ form.amount }}</td>
                    <td class="p-2">{{ form.payment }}</td>
                    <td class="p-2">{{ form.balance }}</td>

                    <!-- Action button -->
                    <td class="p-2">
                        <button  type="button" class="btn btn-sm btn-danger remove-row w-100">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="button" class="btn btn-primary" id="add-row">Add Item</button>
        <button type="submit" class="btn btn-success">Save Invoice</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const addRowBtn = document.getElementById("add-row");
    const tableBody = document.querySelector("#invoice-items-table tbody");
    const totalForms = document.querySelector("#id_invoice_items-TOTAL_FORMS");

    // Update serial numbers
    function updateSerialNumbers() {
        document.querySelectorAll(".serial-number").forEach((td, index) => {
            td.textContent = index + 1;
        });
    }

    // Add new row
    addRowBtn.addEventListener("click", function() {
        const currentFormCount = parseInt(totalForms.value);
        const newForm = tableBody.querySelector("tr").cloneNode(true);

        newForm.querySelectorAll("input, textarea").forEach(input => {
            if (input.name.includes("-DELETE")) {
                input.checked = false;
                return;
            }

            const newName = input.name.replace(
                /-(\d+)-/,
                `-${currentFormCount}-`
            );
            const newId = input.id.replace(/-(\d+)-/, `-${currentFormCount}-`);
            input.name = newName;
            input.id = newId;
            if (input.type !== "hidden" && input.type !== "checkbox") {
                input.value = "";
            }
        });

        tableBody.appendChild(newForm);
        totalForms.value = currentFormCount + 1;
        updateSerialNumbers();
    });

    // Remove row
    tableBody.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-row")) {
            const row = e.target.closest("tr");
            if (tableBody.children.length > 1) {
                row.remove();
                updateSerialNumbers();
            }
        }
    });

    updateSerialNumbers();
});
</script>
{% endblock %}
