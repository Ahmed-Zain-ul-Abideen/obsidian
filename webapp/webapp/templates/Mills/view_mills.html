{% extends 'base.html' %}
{% load role_tags %}
{% block content %}

<div class="row">
  <div class="col-12">

    <!-- Header Card -->
    <div class="card shadow mb-4">
      <div class="card-body d-flex justify-content-between align-items-center">
        {% if request.user.is_superuser %}
          <h3 class="m-0 text-center w-100 fw-bold">All Units</h3>
          
        {% elif request.user|has_group:"Inspectors" %}
          <h3 class="m-0 text-center w-100 fw-bold">Assigned Units</h3>
        {% else %}
          <h3 class="m-0 text-center w-100 fw-bold">My Units</h3>          
        {% endif %}
      </div>
    </div>
    {% if messages %} 
      {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %} 
    {% endif %}

    <div class="card">
      <div class="card-header border-0 align-items-center d-flex pb-0">
        <h4 class="card-title mb-0 flex-grow-1">Mill's Units List</h4>
      </div>

      <div class="card-body pt-2">
        <div class="table-responsive">
          {% if mills_data %}
            <table class="table table-bordered align-middle table-nowrap mb-0 text-center">
              <thead class="table-light">
                <tr>
                  <th>Mill Name</th>
                  <th>Total Units</th>
                  <th>Unit ID</th>
                  <th>NTN</th>
                  <th>GST</th>
                  <th>Spindles</th>
                  <th>Rotors</th>
                  <th>Doubling Machines</th>
                  <th>Assigned Supervisor</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody>
                {% for mill in mills_data %}
                  {% if mill.mills_units.all %}
                    {% for unit in mill.mills_units.all %}
                      {% if request.user|has_group:"Inspectors" %}
                        {% if unit.mill_unit_inspectors  and  unit.mill_unit_inspectors == request.user %}
                          <tr>
                            <td>{{ mill.name }}</td>
                            <td>{{ mill.units }}</td>
                            <td>{{ unit.id }}</td>
                            <td>{{ unit.ntn }}</td>
                            <td>{{ unit.gst }}</td>
                            <td>{{ unit.spindles_installed }}</td>
                            <td>{{ unit.rotors_installed }}</td>
                            <td>{{ unit.doubling_machines_installed }}</td>
                            <td>
                              {% if unit.mill_unit_inspectors %}
                                {{ unit.mill_unit_inspectors.username }}
                              {% else %}
                                <span class="text-muted">Unassigned</span>
                              {% endif %}
                            </td>
                            <td>
                              <div class="d-flex flex-wrap gap-2 justify-content-center">
                                <a href="{% url 'add_inspection_report' unit.mill.id unit.id %}" class="btn btn-warning btn-sm">Add Report</a>
                                <a href="{% url 'edit_mill_unit' unit.id %}" class="btn btn-primary btn-sm">Edit Unit</a>
                              </div>
                            </td>
                          </tr>
                        
                        {% endif %}
                      {% else %}
                        <tr>
                          
                          <td>{{ mill.name }}</td>
                          <td>{{ mill.units }}</td>
                          <td>{{ unit.id }}</td>
                          <td>{{ unit.ntn }}</td>
                          <td>{{ unit.gst }}</td>
                          <td>{{ unit.spindles_installed }}</td>
                          <td>{{ unit.rotors_installed }}</td>
                          <td>{{ unit.doubling_machines_installed }}</td>
                          <td>
                            {% if unit.mill_unit_inspectors %}
                              {{ unit.mill_unit_inspectors.username }}
                            {% else %}
                              <span class="text-muted">Unassigned</span>
                            {% endif %}
                          </td>
                          <td>
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                              {% if request.user.is_superuser %}
                                {% if unit.mill_unit_inspectors %}
                                  <a href="{% url 'assign_inspector' unit.id %}" class="btn btn-warning btn-sm">
                                    Change Supervisor
                                  </a>
                                {% else %}
                                  <a href="{% url 'assign_inspector' unit.id %}" class="btn btn-success btn-sm">
                                    Assign Supervisor
                                  </a>
                                {% endif %}
                                  <a href="{% url 'create_invoice' unit.id %}" class="btn btn-success btn-sm">
                                      Add Invoice
                                  </a>
                              {% elif request.user|has_group:"Inspectors" %}
                                <a href="{% url 'add_inspection_report' unit.mill.id unit.id %}" class="btn btn-warning btn-sm">Add Report</a>
                                <a href="{% url 'edit_mill_unit' unit.id %}" class="btn btn-primary btn-sm">Edit Unit</a>
                              {% elif request.user|has_group:"Mill_owners" %}
                                <a href="{% url 'edit_mill_unit' unit.id %}" class="btn btn-primary btn-sm">Edit Unit</a>
                              {% endif %}
                            </div>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="12" class="text-muted text-center">
                        No units added yet for mill <strong>{{ mill.name }}</strong>.
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="alert alert-info text-center mt-3">
              {% if request.user|has_group:"FBR_officials" %}
                No mills found.
                <a href="{% url 'add_mill_by_fbr_official' %}" class="fw-bold ms-2">Add Mill</a>
              {% elif request.user|has_group:"Inspectors" %}
                No mills assigned to you.
              {% else %}
                No mills found.
                <a href="{% url 'add_mill_by_owner' %}" class="fw-bold ms-2">Add Mill</a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>


  </div>
</div>

{% endblock %}
